En la medida de lo posible tenemos que automatizar todo lo posible. No solo reducimos tiempo sino que reducimos errores, y a la vez, estamos documentando un proceso. Muchas de estas ideas ya las dejé claras en <a href="https://blog.adrianistan.eu/2015/08/04/haz-scripts/">¡Haz scripts!</a> Sin embargo, hay situaciones donde es más complicada esta situación, como por ejemplo, trabajar con máquinas remotas. Aquí entra <a href="http://docs.fabfile.org/en/2.0/index.html">Fabric</a> en acción, una librería para Python que permite automatizar procesos en remoto a través de SSH.<br><br>Originalmente Fabric, compatible únicamente con Python 2, funcionaba a través de unos archivos llamados <em>Fabfile</em> que se ejecutaban con el comando <em>fab</em>. Este mecanismo ha sido transformado por completo en Fabric 2, que ha salido hace nada. Yo ya he hecho la transición y puedo decir que el nuevo sistema, más enfocado a ser una librería sin más, es mucho más práctico y útil que el anterior.<br><br><a href="https://files.adrianistan.eu/Fabric.png"><img class="aligncenter size-full wp-image-1435" src="https://files.adrianistan.eu/Fabric.png" alt="" width="150" height="117" /></a><br><h2>Instalando Fabric</h2><br>Voy a usar <a href="https://docs.pipenv.org/">Pipenv,</a> que es la manera recomendada de gestionar proyectos en Python actualmente.<br><pre class="lang:default decode:true">pipenv install fabric==2.0.1</pre><br>Y accedemos al virtualenv con:<br><pre class="lang:default decode:true">pipenv shell</pre><br><h2>Conexiones</h2><br>El elemento fundamental de Fabric a partir de la versión 2 son las conexiones. Estos objetos representan la conexión con otra máquina y podemos:<br><ul><br> 	<li>ejecutar comandos en el shell de la otra máquina, <strong>run, sudo.</strong></li><br> 	<li>descargar archivos desde la máquina remota a local, <strong>get</strong></li><br> 	<li>subir archivos de local a remoto, <strong>put</strong></li><br> 	<li>hacer forwarding, <strong>forward_local</strong>, <strong>forward_remote</strong>.</li><br></ul><br>Para iniciar una conexión necesitamos la dirección de la máquina y alguna manera de identificarnos. En todo el tema de la autenticación Fabric delega el trabajo en Paramiko, que soporta gran variedad de opciones, incluida la opción de usar gateways.<br><br>Vamos a mostrar un ejemplo, en este caso, de autenticación con contraseña:<br><pre class="lang:python decode:true ">from fabric import Connection<br>from getpass import getpass<br><br>password = getpass(prompt="Password for Numancia: ")<br>numancia = Connection(host="192.168.0.158",user="roma",connect_kwargs={"password" : password})</pre><br>El objeto creado con Connection ya lo podemos usar. Habitualmente no es necesario cerrar la conexión aunque en casos extremos puede ser necesario, una manera es llamando a <strong>close</strong>, otra es con un bloque <strong>with.</strong><br><h2>Tareas</h2><br>Una vez que ya tenemos la conexión podemos pasárselo a diferentes funciones, cada una con una tarea distinta. Veamos algunos ejemplos.<br><h4>Actualizar con apt</h4><br><pre class="lang:python decode:true">def update(cxn):<br>    cxn.run("sudo apt update")<br>    cxn.sudo("apt upgrade -y")</pre><br>Los comandos que necesiten sudo pueden necesitar una pseudo-terminal para preguntar la contraseña (si es que la piden, no todos los servidores SSH piden contraseña al hacer sudo). En ese caso añadimos, pty=True.<br><pre class="lang:python decode:true ">def update(cxn):<br>    cxn.run("sudo apt update",pty=True)<br>    cxn.run("sudo apt upgrade -y",pty=True)</pre><br>&nbsp;<br><h4>Backup de Mysql/Mariadb y cifrado con gpg</h4><br><pre class="lang:default decode:true">def backup_sql(cxn):<br>    date = time.strftime("%Y%m%d%H%M%S")<br>    filename = "/tmp/blog-backup-"+date+".sql.gz"<br><br>    cxn.run("sudo mysqldump blog | gzip &gt; "+filename)<br>    local_filename = "backups/"+os.path.basename(filename)<br>    cxn.get(filename,local_filename)<br>    cxn.run("sudo rm "+filename)<br>    os.system("gpg --cipher-algo AES256 -c "+local_filename)<br>    os.remove(local_filename)</pre><br><em>Requiere que MySQL/MariaDB esté configurado con la opción de autenticación POSIX (modo por defecto en el último Ubuntu)</em><br><br>Como véis, usar Fabric es muy sencillo, ya que apenas se diferencia de un script local.<br><br><a href="https://files.adrianistan.eu/FabricLogin.png"><img class="aligncenter size-full wp-image-1436" src="https://files.adrianistan.eu/FabricLogin.png" alt="" width="716" height="254" /></a><br><br>Si queremos obtener el resultado del comando, podemos simplemente asignar a una variable la evaluación de los comandos run/sudo.<br><pre class="lang:python decode:true">def isLinux(cxn):<br>    result = cxn.run("uname -s")<br>    return result.stdout.strip() == "Linux"<br></pre><br><h2>Grupos</h2><br>Fabric es muy potente, pero en cuanto tengamos muchas máquinas vamos a hacer muchas veces las mismas tareas. Podemos usar un simple bucle <strong>for</strong>, pero Fabric nos trae una abstracción llamada <strong>Group</strong>. Básicamente podemos juntar conexiones en un único grupo y este ejecutas las acciones que pidamos. Existen dos tipos de grupo, <strong>SerialGroup</strong>, que ejecuta las operaciones secuencialmente y <strong>ThreadGroup</strong> que las ejecuta en paralelo.<br><pre class="lang:python decode:true">from fabric import ThreadingGroup<br><br>def update(cxn):<br>    cxn.run("sudo apt update")<br><br><br>pool = ThreadingGroup("roma@192.168.0.158","madrid@192.168.0.155")<br>update(pool)</pre><br>O si tienes ya objetos de conexión creados:<br><pre class="lang:python decode:true">from fabric import ThreadingGroup<br><br>def update(cxn):<br>    cxn.run("sudo apt update")<br><br>pool = ThreadingGroup.from_connections([roma,madrid])<br>update(pool)</pre><br>Con esto ya deberías saber lo básico para manejar Fabric, una fantástica librería para la automatización en remoto. Yo la uso para este blog y otras webs. Existen alternativas como <strong>Ansible</strong>, aunque a mí nunca me ha terminado de gustar su manera de hacer las cosas, que requiere mucho más aprendizaje.