Continuamos con el tutorial de WebExtensions, hoy veremos un elemento muy útil para muchas extensiones que es el popup.<br><h2>¿Qué es el popup?</h2><br>El popup es un panel desplegable que se acciona al pulsar un botón de acción. Este panel es una página HTML que puede contener código JavaScript.<br><br><img class="alignnone size-full wp-image-563" src="https://files.adrianistan.eu/PopUp.png" alt="popup" width="911" height="618" /><br><br>El popup es el elemento que permite al usuario un mayor control sobre la extensión y es ideal tanto para mostrar información como para contener acciones. De hecho, WebExtensions limita el número de botones de acción que puede crear una extensión a uno. Si queremos simular tener más botones deberemos usar un popup que despliegue un pequeño menú.<br><h2>Definir el popup en manifest.json</h2><br>Para definir el popup tenemos que indicar la ubicación del fichero HTML correspondiente al popup.<br><br><pre class="lang:js decode:true"><br>	&quot;browser_action&quot; : {<br>		&quot;default_icon&quot; : &quot;icons/icono_guay.png&quot;,<br>		&quot;default_title&quot; : &quot;Mi PopUp guay&quot;,<br>		&quot;default_popup&quot; : &quot;popup/index.html&quot;<br>},<br></pre><br><br>Con eso ya tenemos definido el popup. Se mostrará el botón en la barra superior y al hacer click se abrirá el popup.<br><h2>El PopUp en sí</h2><br>El PopUp es un fichero HTML sin el mayor misterio. Para definir el tamaño del PopUp usaremos CSS:<br><br><pre class="lang:css decode:true"><br>body{<br>    width: 400px;<br>    height: 400px;<br>}<br></pre><br><br>Y el navegador adaptará el PopUp a esas dimensiones. A ese archivo HTML le podemos añadir archivos JavaScript mediante el procedimiento habitual en la web, vía una etiqueta script. Lo interesante viene en estos archivos de JavaScript pues cuentan con más privilegios. Desde ellos podemos acceder a las APIs retringidas a extensiones así como librarnos de limitaciones impuestas a las webs (como la política que bloquea los XMLHttpRequests ejecutados a dominios ajenos a nuestra página).<br><br>Para usar las APIs restringidas debemos pedir permiso en el fichero manifest.json. Por ejemplo, vamos a jugar con las pestañas. Para ello usamos los permisos tabs y activeTab.<br><br><pre class="lang:js decode:true"><br>    &quot;permissions&quot; : [&quot;tabs&quot;,&quot;activeTab&quot;],<br></pre><br><br><h2>Tabs (pestañas) en WebExtensions</h2><br>La API se encuentra en chrome.tabs y dispone de varios métodos y eventos. Vamos a ver los más importantes:<br><ul><br> 	<li>chrome.tabs.query - Obtener información de las pestañas<br><ul><br> 	<li>Este método es muy flexible, lo podemos comparar a hacer un SELECT en SQL, pues obtiene una lista de pestañas que cumplen los parámetros que hemos indicado. Por ejemplo para comprobar la pestaña actual, usaremos la propiedad active:<br><br><pre class="lang:js decode:true"><br>chrome.tabs.query({&quot;active&quot;: true},function(tabs){<br>    var tab = tabs[0];<br>    // tab es la pestaña actualmente activa <br>});<br></pre><br><br>Otra opción muy interesante es para averiguar que pestañas tienen abierta una URL que cumple un patrón. Además los parámetros de búsqueda se pueden combinar:<br><br><pre class="lang:js decode:true"><br>chrome.tabs.query({&quot;url&quot; : &quot;*://*.adrianistan.eu/*&quot;, &quot;status&quot; : &quot;loading&quot;, &quot;muted&quot; : true},function(tabs){<br>  // tabs (que puede estar vacío) contiene todas las URL que estan en un adrianistan.eu (subdominios incluidos),<br>  // se encuentran cargando<br>  // y el usuario ha silenciado su sonido<br>});<br></pre><br><br></li><br></ul><br></li><br> 	<li>chrome.tabs.create - Permite crear nuevas pestañas<br><ul><br> 	<li>Su uso básico es muy simple<br><br><pre class="lang:js decode:true"><br>chrome.tabs.create({&quot;url&quot; : &quot;https://blog.adrianistan.eu/&quot;},function(tab){<br>  // tab es la pestaña creada<br>});<br></pre><br><br></li><br></ul><br></li><br> 	<li>chrome.tabs.executeScript - Esta función permite inyectar a la pestaña un script de contenido (Content Script).<br><ul><br> 	<li>Ahora no vamos a entrar en como se realizaría la comunicación entre los scripts Background y los Content. El código se puede pasar por una cadena de texto o por un archivo, siendo preferible esta última opción. Se puede especificar además cuando queremos que se ejecute dentro del ciclo de carga de la pestaña.<br><br><pre class="lang:js decode:true"><br>chrome.tabs.executeScript(tab.id (opcional), {&quot;code&quot; : &quot;alert('Hola');&quot;},function(){<br><br>});<br><br>O<br><br>chrome.tabs.executeScript({&quot;file&quot; : &quot;miarchivo.js&quot;, &quot;runAt&quot; : &quot;document_start&quot;},function(){<br><br>});<br></pre><br><br></li><br></ul><br></li><br> 	<li>chrome.tabs.insertCSS - Permite inyectar CSS en la pestaña<br><ul><br> 	<li>Su uso es exactamente igual al de chrome.tabs.executeScript<br><br><pre class="lang:js decode:true"><br>chrome.tabs.insertCSS({&quot;file&quot; : &quot;misestilos.css&quot;},function(){<br><br>});<br></pre><br><br></li><br></ul><br></li><br> 	<li>chrome.tabs.sendMessage - Enviar un mensaje a la pestaña<br><ul><br> 	<li>Hasta ahora no hemos visto la separación entre background y content scripts. Esta función permite enviar datos desde los scripts background a los content, que tendrán una función de escucha. La menciono, pero lo veremos más adelante en profundidad.</li><br></ul><br></li><br></ul><br>Por último, veamos algunos de los eventos que puede generar la API.<br><ul><br> 	<li>chrome.tabs.onUpdated - Es llamado cada vez que una pestaña sufre una modificación en sus datos (cambio de URL, quitar el sonido, finalizar una carga, etc)<br><ul><br> 	<li>Es muy posible que necesitemos filtrar el contenido que nos da, para fijarnos si se ha producido en una URL que nos interesa o en alguna condición relevante. Eso no obstante, es responsabilidad del programador.<br><br><pre class="lang:js decode:true"><br>chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){<br>  // el objeto changeInfo presenta una estructura similar al de búsqueda con chrome.tabs.query<br>  // este objeto solo contiene valores para aquellos parámetros que han cambiado<br>  // con tab podemos acceder a la pestaña al completo<br>});<br></pre><br><br></li><br></ul><br></li><br></ul><br>Con esto ya podemos hacer extensiones interesantes, la APIs de PopUp y de Tabs son de las más usadas en WebExtensions.