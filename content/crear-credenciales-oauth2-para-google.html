Google dispone de muchas APIs a nuestra disposición de forma gratuita. Para poder usarla es necesario que hayamos iniciado sesión. Desde un navegador como Firefox o Chrome es muy sencillo, introducimos nuestro usuario y contraseña y ya podemos acceder a Gmail, YouTube, etc. Si queremos hacerlo desde nuestro propio programa también es posible, pero el procedimiento es distinto. Una vez hagamos esto podremos hacer lo mismo que haría un usuario, lo único que programándolo (leer los contactos, leer el correo, modificar suscripciones de YouTube, publicar en Blogger, etc).<br><h2>Crea un proyecto de API</h2><br>Crea un proyecto de Google y crea unos credenciales nuevos en la <a href="https://console.developers.google.com/apis/">consola de APIs de Google.</a><br><br><img class="alignnone size-large wp-image-460" src="https://files.adrianistan.eu/screenshot-console-developers-google-com-2016-07-26-14-52-43-1024x493.png" alt="screenshot-console developers google com 2016-07-26 14-52-43" width="840" height="404" /><br><br>Los credenciales pueden ser de varios tipos: clave de API, ID de OAuth y cuenta de servicio. La clave de API solo funciona en algunas API, el ID de OAuth es el sistema universal y la cuenta de servicio es para APIs de desarrollo. Creamos un ID de OAuth, pues es el método más universal.<br><br><img class="alignnone size-large wp-image-461" src="https://files.adrianistan.eu/screenshot-console-developers-google-com-2016-07-26-16-29-16-1024x493.png" alt="screenshot-console developers google com 2016-07-26 16-29-16" width="840" height="404" /><br><br>Dependiendo de dónde opere nuestra aplicación tendremos un método u otro. El método Web requiere disponer de un servidor web y es el sistema óptimo si tenemos una aplicación Web (por ejemplo, tenemos una red social y queremos una opción de leer contactos de Gmail, usaríamos Web, pues es el procedimiento más cómodo). Si tu programa no tiene un servidor web detrás (es un programa normal de Windows, una herramienta de línea de comandos, un plugin de Firefox,...) usa Otro. Voy a explicar como funciona Otro.<br><br><img class="alignnone size-large wp-image-462" src="https://files.adrianistan.eu/screenshot-console-developers-google-com-2016-07-26-16-30-31-1024x493.png" alt="screenshot-console developers google com 2016-07-26 16-30-31" width="840" height="404" /><br><br>Obtendremos un ID de cliente y un secreto de cliente. Guardamos esas dos claves, son muy importantes. Ahora vamos a activar las APIs. A la izquierda accedemos a Biblioteca. Buscamos la APIs que queramos usar y las activamos.<br><br><img class="alignnone size-large wp-image-463" src="https://files.adrianistan.eu/screenshot-console-developers-google-com-2016-07-26-16-36-27-1024x493.png" alt="screenshot-console developers google com 2016-07-26 16-36-27" width="840" height="404" /><br><h2>Obteniendo un access_token y un refresh_token</h2><br>Para poder llamar a la API de Google es necesario tener un access_token. Los access_token caducan a las pocas horas. Para poder seguir realizando operaciones en la API pasado ese tiempo necesitamos un refresh_token. El refresh_token sirve exclusivamente para pedir un access_token nuevo. Este no caduca, pero no garantiza que siempre nos devuelva un access_token pues puede que el usuario haya decidido eliminar el permiso a nuestro programa.<br><br>El procedimiento de OAuth2 es el siguiente:<br><ol><br> 	<li>Nuestra aplicación quiere autenticar al usuario en Google</li><br> 	<li>Nuestra aplicación genera una URL especial que debe abrir el usuario en el navegador</li><br> 	<li>En esa URL inicia sesión en Google el usuario, igual que si fuera a iniciar sesión en Gmail</li><br> 	<li>Se le informa al usuario de los permisos/APIs que nuestro programa quiere usar</li><br> 	<li>El usuario acepta o rechaza</li><br> 	<li>Si acepta ocurren varias cosas dependiendo del método. Si elegiste Otro se mostrará un código que deberás copiar en la aplicación.</li><br> 	<li>Ese código la aplicación lo envía a Google junto a nuestros datos de client ID y client secret.</li><br> 	<li>Google nos envía el access_token y el refresh_token.</li><br></ol><br><h2>Elaborar la URL de inicio de sesión</h2><br>En la URL de inicio de sesión figuran varios datos.<br><ul><br> 	<li>El tipo de petición</li><br> 	<li>Los permisos o APIs a las que queremos acceder (scopes)</li><br> 	<li>Nuestro ID de cliente</li><br> 	<li>Y la URL de redirección, que en nuestro caso, es especial.</li><br></ul><br>En este ejemplo vemos una petición, con dos APIs o permisos, Chrome WebStore y Google Play.<br><pre>https://accounts.google.com/o/oauth2/auth?response_type=code&amp;scope=https://www.googleapis.com/auth/chromewebstore+https://www.googleapis.com/auth/androidpublisher&amp;client_id=AQUI EL ID DE CLIENTE&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob</pre><br><h2>Validar el código</h2><br>El usuario nos dará el código que le haya dado Google. Nosotros ahora para obtener el access_token y el refresh_token tenemos que enviarlo de vuelta. En Curl el comando sería el siguiente:<br><pre>curl "https://accounts.google.com/o/oauth2/tken" -d "client_id=AQUI EL ID DE CLIENTE&amp;client_secret=AQUI EL CLIENT SECRET&amp;code=ESTE ES EL CÓDIGO QUE NOS DA EL USUARIO&amp;grant_type=authorization_code&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob"</pre><br>La respuesta, en un fichero JSON, contendrá el access_token y el refresh_token. En las librerías de APIs de Google muchas veces basta con especificar el client ID, el client secret y el refresh_token, pues se encargan de pedir automáticamente el access_token.