Chromecast (o Google Cast) es un dongle, un pequeño aparato, que se conecta a una entrada HDMI y permite disfrutar de contenido multimedia a un precio bastante ajustado (35$). Oficialmente solo se puede programar usando los SDK de iOS, Android y Chrome pero la comunidad ha conseguido replicar el protocolo interno. Chromecast ha tenido varios protocolos de comunicación pero el importante para lo que vamos a realizar se llama CASTv2.<br><br><img class="alignnone size-large wp-image-20" src="https://files.adrianistan.eu/chromecast-box-1024x683.jpg" alt="chromecast-box" width="840" height="560" /><br><h2 id="cmofuncionachromecastpordentro">¿Cómo funciona Chromecast por dentro?</h2><br>Primero voy a explicar como funciona el Chromecast. Chromecast sigue la filosofía de los Chromebooks, en el que todo el sistema es el navegador web, en este caso Chrome. Una app se conecta a Chromecast a través del protocolo de descubrimiento, deben estar en la misma red Wi-Fi. La aplicación solicita iniciar una aplicación, para lo cual manda el ID de la aplicación que desea abrir. Chromecast busca en la base de datos de Google (<a href="https://cast.google.com">https://cast.google.com</a>, tasa de registro de 5$) y allí le indicará una URL.<br><br>Chromecast abre la web y ejecuta la aplicación, que usando una librería de JavaScript le permite comunicarse con la app original. Podemos distinguir sin embargo varias aplicaciones "preinstaladas". Son webs como el resto pero están alojadas por Google sin marca. Son DefaultMediaReceiver y StyledMediaReceiver. Se trata de dos reproductores multimedia básicos, que soportan vídeo en MP4 y WebM desde una URL, subtítulos, carátula y en el caso de StyledMediaReceiver es posible modificar un poco el aspecto del reproductor.<br><br><img class="alignnone size-full wp-image-19" src="https://files.adrianistan.eu/chromecast.png" alt="chromecast" width="785" height="823" /><br><h2 id="reproduciendounvdeoconchromecastnodejsydefaultmediareceiver">Reproduciendo un vídeo con Chromecast, Node.js y DefaultMediaReceiver</h2><br>Como hemos visto, reproducir un vídeo en Chromecast no es muy difícil. Para ello me voy a ayudar en la librería <a href="https://github.com/guerrerocarlos/chromecast-js">chromecast-js</a> que en última instancia remite a <a href="https://github.com/thibauts/node-castv2-client">node-castv2-client</a>.<br><br>En un ordenador, dentro de la misma red Wi-Fi que el Chromecast y con Node.js instalado ejecutamos:<br><pre><code><br>mkdir chromecast-video <br>cd chromecast-video <br>npm install chromecast-js <br></code></pre><br>Creamos un archivo de JavaScript con el siguiente contenido<br><br><pre class="lang:js decode:true"><br>var chromecastjs = require('chromecast-js'); // Obtenemos la librería<br><br>var browser = new chromecastjs.Browser(); // Iniciamos la búsqueda<br><br>browser.on('deviceOn', function(device){ // Cuando encuentre un dispositivo...<br>  device.connect(); // Nos conectamos a él<br>  device.on('connected', function(){ // Y cuando nos conectemos<br><br>    device.play('http://commondatastorage.googleapis.com/gtv-videos-bucket/big_buck_bunny_1080p.mp4', 60, function(){ // Mandamos reproducir el vídeo Big Buck Bunny, en MP4, no desde el principio, sino desde el primer minuto<br>        console.log('Reproduciendo en el Chromecast!');<br>    });<br><br>    setTimeout(function(){ // Pasados 30 segundos paramos el vídeo<br>        device.pause(function(){<br>            console.log('Paused!')<br>        });<br>    }, 30000);<br><br>    setTimeout(function(){ // Pasados otros 10 segundos más, se corta la retransmisión<br>        device.stop(function(){<br>            console.log('Stoped!')<br>        });<br>    }, 40000);<br><br>  })<br>})<br></pre><br><br>Es un ejemplo muy sencillo. Como veis, Chromecast se conecta directamente al vídeo que reproduce, el dispositivo de control solo es eso, solo controla, nunca envía la película.<br><h2 id="personalizandoconstyledmediareceiver">Personalizando con StyledMediaReceiver</h2><br>El módulo <code>chromecast-js</code> también permite usar el StyledMediaReceiver, cuyo funcionamiento es idéntico al de DefaultMediaReceiver pero se le puede personalizar el aspecto. Además añadimos subtítulos (formato WebVTT) y una carátula.<br><br><pre class="lang:js decode:true"><br>var chromecastjs = require('chromecast-js')<br><br>var browser = new chromecastjs.Browser()<br><br>var media = {<br>    url : 'http://commondatastorage.googleapis.com/gtv-videos-bucket/big_buck_bunny_1080p.mp4', // El vídeo<br>    subtitles: [{<br>        language: 'en-US',<br>        url: 'http://carlosguerrero.com/captions_styled.vtt',<br>        name: 'English',<br>    },<br>    {<br>        language: 'es-ES',<br>        url: 'http://carlosguerrero.com/captions_styled_es.vtt',<br>        name: 'Spanish',<br>    }<br>    ], // Los subítulos, un fichero para inglés y otro para español, en formato WebVTT<br>    cover: {<br>        title: 'Big Bug Bunny',<br>        url: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/BigBuckBunny.jpg' // Carátula, se muestra cuando el vídeo se está cargando<br>    },<br>    subtitles_style: { <br>          backgroundColor: '#FFFFFFFF', // see http://dev.w3.org/csswg/css-color/#hex-notation<br>          foregroundColor: '#000FFFF', // see http://dev.w3.org/csswg/css-color/#hex-notation<br>          edgeType: 'DROP_SHADOW', // can be: &quot;NONE&quot;, &quot;OUTLINE&quot;, &quot;DROP_SHADOW&quot;, &quot;RAISED&quot;, &quot;DEPRESSED&quot;<br>          edgeColor: '#AA00FFFF', // see http://dev.w3.org/csswg/css-color/#hex-notation<br>          fontScale: 1.5, // transforms into &quot;font-size: &quot; + (fontScale*100) +&quot;%&quot;<br>          fontStyle: 'BOLD_ITALIC', // can be: &quot;NORMAL&quot;, &quot;BOLD&quot;, &quot;BOLD_ITALIC&quot;, &quot;ITALIC&quot;,<br>          fontFamily: 'Droid Sans',<br>          fontGenericFamily: 'CURSIVE', // can be: &quot;SANS_SERIF&quot;, &quot;MONOSPACED_SANS_SERIF&quot;, &quot;SERIF&quot;, &quot;MONOSPACED_SERIF&quot;, &quot;CASUAL&quot;, &quot;CURSIVE&quot;, &quot;SMALL_CAPITALS&quot;,<br>          windowColor: '#AA00FFFF', // see http://dev.w3.org/csswg/css-color/#hex-notation<br>          windowRoundedCornerRadius: 10, // radius in px<br>          windowType: 'ROUNDED_CORNERS' // can be: &quot;NONE&quot;, &quot;NORMAL&quot;, &quot;ROUNDED_CORNERS&quot;<br>    } // Aquí creamos un estilo para los subtítulos, la notación es fácil si ya conoces CSS<br>}<br><br><br>browser.on('deviceOn', function(device){<br>  device.connect()<br>  device.on('connected', function(){<br><br>    // Iniciamos la retransmisión, pero esta vez enviamos más información al Chromecast, usaremos StyledMediaReceiver<br>    device.play(media, 0, function(){<br>        console.log('Playing in your chromecast!')<br><br>        setTimeout(function(){<br>            console.log('subtitles off!')<br>            device.subtitlesOff(function(err,status){ // Desactivamos los subtítulos<br>                if(err) console.log(&quot;error setting subtitles off...&quot;)<br>                console.log(&quot;subtitles removed.&quot;)<br>            });<br>        }, 20000);<br><br>        setTimeout(function(){<br>            console.log('subtitles on!')<br>            device.changeSubtitles(1, function(err, status){ // Restablecemos los subtítulos, pero al Español<br>                if(err) console.log(&quot;error restoring subtitles...&quot;)<br>                console.log(&quot;subtitles restored.&quot;)<br>            });<br>        }, 25000);<br><br>        setTimeout(function(){<br>            device.pause(function(){<br>                console.log('Paused!')<br>            });<br>        }, 30000);<br><br>        setTimeout(function(){<br>            device.unpause(function(){<br>                console.log('unpaused!')<br>            });<br>        }, 40000);<br><br>        setTimeout(function(){<br>            console.log('I ment English subtitles!')<br>            device.changeSubtitles(0, function(err, status){<br>                if(err) console.log(&quot;error restoring subtitles...&quot;)<br>                console.log(&quot;English subtitles restored.&quot;)<br>            });<br>        }, 45000);<br><br>        setTimeout(function(){<br>            console.log('Increasing subtitles size...')<br>            device.changeSubtitlesSize(10, function(err, status){ // Cambiamos el tamaño de los subtítulos<br>                if(err) console.log(&quot;error increasing subtitles size...&quot;)<br>                console.log(&quot;subtitles size increased.&quot;)<br>            });<br>        }, 46000);<br><br>        setTimeout(function(){<br>            device.seek(30,function(){ // Nos movemos dentro del vídeo<br>                console.log('seeking forward!')<br>            });<br>        }, 50000);<br><br>        setTimeout(function(){<br>            console.log('decreasing subtitles size...')<br>            device.changeSubtitlesSize(1, function(err, status){<br>                if(err) console.log(&quot;error...&quot;)<br>                console.log(&quot;subtitles size decreased.&quot;)<br>            });<br>        }, 60000);<br><br>        setTimeout(function(){<br>            device.pause(function(){<br>                console.log('Paused!')<br>            });<br>        }, 70000);<br><br>        setTimeout(function(){<br>            device.seek(30,function(){<br>                console.log('seeking forward!')<br>            });<br>        }, 80000);<br><br>        setTimeout(function(){<br>            device.seek(30,function(){<br>                console.log('seeking forward!')<br>            });<br>        }, 85000);<br><br>        setTimeout(function(){<br>            device.unpause(function(){<br>                console.log('unpaused!')<br>            });<br>        }, 90000);<br><br><br>        setTimeout(function(){<br>            device.seek(-30,function(){<br>                console.log('seeking backwards!')<br>            });<br>        }, 100000);<br><br><br>        setTimeout(function(){<br>            device.stop(function(){<br>                console.log('Stoped!')<br>            });<br>        }, 200000);<br><br>    })<br>  })<br>}<br></pre><br><br>En definitiva, para muchas aplicaciones este módulo es más que suficiente. En caso de que queramos llevar un juego a Chromecast la cosa se complica. Tenemos que programar una app del tipo CustomMediaReceiver en HTML5 y luego su cliente (en Node.js o usando las librerías oficiales de Google para Android, iOS y Chrome). Si os ha gustado esta entrada y queréis saber como realizar esto último, compartid y comentad, me gustaría saber que opináis al respecto y podéis darme ideas.