<blockquote><em>Este artículo lo escribí para el blog en español <a href="http://blog.desdelinux.net">DesdeLinux</a> el 25 de agosto de 2014 y ahora lo dejo aquí, en mi blog personal. El artículo está tal cual, sin ninguna modificación desde aquella fecha.</em></blockquote><br>Bienvenidos a otro post sobre cómo crear nuestro propio sistema operativo. Ha pasado mucho tiempo desde el último post, debido principalmente a un bug que encontré en lo que nos toca hoy. Veremos cómo manejar el reloj en arquitecturas x86.<br><br>Anteriormente habíamos activado los IRQ de manera genérica, pero hubo un pequeño problema ya que no los activábamos correctamente y pasábamos datos extra. Finalmente lo solucionamos <strong>carlosorta</strong> y yo y os puedo seguir comentando cómo seguir.<br><br>Bien, el reloj es un IRQ, concretamente el primero. Para configurarlo usaremos la función que definimos anteriormente para instalar de manera genérica los IRQ, la ND<em>IRQ</em>InstallHandler.<br><br><pre class="lang:c++ decode:true"><br>int ND_TIMER_TICKS=0;<br><br>void ND::Timer::Phase(int hz)<br>{<br>	int divisor=1193180/hz;<br>	ND::Ports::OutputB(0x43,0x36);<br>	ND::Ports::OutputB(0x40, divisor &amp; 0xFF);<br>	ND::Ports::OutputB(0x40, divisor &gt;&gt; 8);<br>}<br>void ND::Timer::Wait(int ticks)<br>{<br>	unsigned long eticks;<br>	eticks=ND_TIMER_TICKS+ticks;<br>	while(ND_TIMER_TICKS &lt; eticks)<br>	{<br>		<br>	}<br>}<br>void ND::Timer::Setup()<br>{<br>	ND::Screen::SetColor(ND_SIDE_FOREGROUND, ND_COLOR_BLACK);<br>	ND::Screen::PutString(&quot;\nSetup timer...&quot;);<br>	<br>	ND_IRQ_InstallHandler(0,&amp;ND_Timer_Handler);<br>	<br>	ND::Screen::SetColor(ND_SIDE_FOREGROUND,ND_COLOR_GREEN);<br>	ND::Screen::PutString(&quot;done&quot;);<br>}<br>extern &quot;C&quot;<br>void ND_Timer_Handler(struct regs* r)<br>{<br>	ND_TIMER_TICKS++;<br>	if(ND_TIMER_TICKS % 18 ==0)<br>	{<br>		ND::Screen::SetColor(ND_SIDE_FOREGROUND,ND_COLOR_BROWN);<br>		ND::Screen::PutString(&quot;\nOne more second&quot;); WE SHOULD DO A REFRESH SCREEN<br>	}<br>}<br></pre><br><br>El código se ejecuta de la siguiente manera: el sistema de inicialización llama a <strong>ND::Timer::Setup</strong>, que llama a <strong>ND<em>IRQ</em>InstallHandler</strong> para insertar en la primera posición, el IRQ0, una función de callback cuando el evento se produzca, esa es <strong>ND<em>Timer</em>Handler</strong> que aumenta los ticks. Como hemos puesto la velocidad del reloj a 18 Hz, como veremos más adelante, si lo dividiésemos entre 18 y nos diese entero habría pasado un segundo.<br><br>La función <strong>ND::Timer::Phase</strong> nos sirve para ajustar la velocidad del timer, ese número tan extravagante es 1.19 MHz que es un valor común. Bien, esta función la deberemos llamar si quisiésemos cambiar la velocidad del timer, por defecto va a 18,22 Hz, un valor peculiar que debió de decidir alguien dentro de <a href="http://ibm.com">IBM</a> y se ha quedado hasta nuestros días.<br><br>La función <strong>ND::Timer::Wait</strong> es bastante simple, solamente espera con un bucle <em>while</em> hasta que se hayan alcanzado los <em>ticks</em> necesarios para continuar.<br><br>En la imagen podemos comprobar que si descomentamos el código dentro del ND<em>Timer</em>Handler obtenemos esto:<br><br><img class="alignnone size-full wp-image-87" src="https://files.adrianistan.eu/NextDivelSegundos.png" alt="NextDivelSegundos" width="600" height="356" />