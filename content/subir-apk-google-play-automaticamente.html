Hoy vamos a ver como subir un APK a Google Play directamente, usando la línea de comandos, sin pasar por el navegador. Perfecto para automatizar la publicación de actualizaciones.<br><br><img class="alignnone size-full wp-image-466" src="https://files.adrianistan.eu/desarrollador-android-680x394.jpg" alt="desarrollador-android-680x394" width="680" height="394" /><br><br>&nbsp;<br><br>Google Play, como muchos otros servicios de Google, dispone de una API. Gracias a ella podemos interactuar con los servicios de Google directamente desde nuestro código. Para ello necesitaremos un Client ID, un Client Secret y un refresh_token. En mi entrada sobre <a href="https://blog.adrianistan.eu/2016/07/26/crear-credenciales-oauth2-para-google/">como crear credenciales OAuth2 para Google</a> sabras como hacerlo. Busca la API de Google Play Android Developer API y actívala. Anota el client ID, el client secret y el refresh_token. Además es necesario que entres a la <a href="https://play.google.com/apps/publish/">consola de desarrollo de Google Play</a> y autorices tus credenciales en Configuración -&gt; Acceso a API<br><br><img class="alignnone size-large wp-image-465" src="https://files.adrianistan.eu/screenshot-play-google-com-2016-07-26-17-23-56-1024x499.png" alt="screenshot-play google com 2016-07-26 17-23-56" width="840" height="409" /><br><br>Ahora podemos pasar a escribir nuestro script de subida de APK. Para ello usaremos Node.js y el fantástico paquete <strong><a href="https://www.npmjs.com/package/googleapis">googleapis</a></strong>, que se encuentra en npm.<br><h2>Iniciar sesión en googleapis</h2><br>Primero instala el paquete con npm.<br><pre>npm install googleapis</pre><br>Teniendo a mano el client ID, el client secret y el refresh_token podemos iniciar sesión.<br><br><pre class="lang:js decode:true"><br>var CLIENT_ID=&quot;&quot;;<br>var CLIENT_SECRET=&quot;&quot;;<br>var REFRESH_TOKEN=&quot;&quot;;<br><br>var fs = require(&quot;fs&quot;);<br>var google = require(&quot;googleapis&quot;);<br>var androidpublisher = google.androidpublisher(&quot;v2&quot;); // Esta es la API que vamos a usar, AndroidPublisher v2<br>var OAuth2 = google.auth.OAuth2;<br><br>var auth = new OAuth2(CLIENT_ID,CLIENT_SECRET,&quot;&quot;);<br>auth.setCredentials({<br>	refresh_token: REFRESH_TOKEN<br>});<br><br>auth.refreshAccessToken(function(err,tokens){<br>	google.options({auth: auth});<br>	// Ya estamos dentro<br>});<br></pre><br><br><h2>Crear y publicar una edición</h2><br>¿Cuál es el procedimiento para subir un APK a Google Play usando la API?<br><ol><br> 	<li>Crear una nueva <em>edición</em></li><br> 	<li>Subir un APK a esa <em>edición</em></li><br> 	<li>Asignar el APK a algún canal de distribución</li><br> 	<li>Guardar y publicar los cambios de la <em>edición</em></li><br></ol><br>Cuando creemos una edición se nos dará un ID de edición. Lo usaremos en el resto de llamadas. También cuando subamos un APK nos darán un versionCode que usaremos para asignar a uno de los canales de distribución. Google Play dispone de 4 canales de distribución:<br><ul><br> 	<li>alpha: Solo para los usuarios que hayas autorizado explícitamente</li><br> 	<li>beta: Solo para los usuarios que hayas autorizado explícitamente</li><br> 	<li>production: La versión que tienen todos los usuarios que no están registrados en alpha y beta.</li><br> 	<li>rollout: Similar a production. Se indica un procentaje y Google se encargará de que solo el porcentaje de usuarios indicado tengan la actualización. Es ideal para probar nuevas características sin involucrar a todos tus usuarios.</li><br></ul><br>Finalmente el código final del script queda así.<br><br><pre class="lang:js decode:true"><br>var CLIENT_ID=&quot;&quot;;<br>var CLIENT_SECRET=&quot;&quot;;<br>var REFRESH_TOKEN=&quot;&quot;;<br><br>var fs = require(&quot;fs&quot;);<br>var google = require(&quot;googleapis&quot;);<br>var androidpublisher = google.androidpublisher(&quot;v2&quot;);<br>var OAuth2 = google.auth.OAuth2;<br><br>var auth = new OAuth2(CLIENT_ID,CLIENT_SECRET,&quot;&quot;);<br>auth.setCredentials({<br>	refresh_token: REFRESH_TOKEN<br>});<br><br>auth.refreshAccessToken(function(err,tokens){<br>	google.options({auth: auth});<br>	androidpublisher.edits.insert({<br>		packageName: &quot;ga.yayeyo.cronoquiz.historia&quot;<br>	},function(err,edit){<br>		console.dir(err);<br>		androidpublisher.edits.apks.upload({<br>			packageName: &quot;ga.yayeyo.cronoquiz.historia&quot;,<br>			editId: edit.id,<br>			uploadType: &quot;media&quot;,<br>			media: {<br>				mediaType: &quot;application/vnd.android.package-archive&quot;,<br>				body: fs.createReadStream(&quot;platforms/android/build/outputs/apk/android-release.apk&quot;)<br>			}<br>		},function(err,req){<br>			console.dir(err);<br>			var versionCode = req.versionCode;<br>			androidpublisher.edits.tracks.update({<br>				packageName: &quot;ga.yayeyo.cronoquiz.historia&quot;,<br>				editId: edit.id,<br>				track: &quot;production&quot;,<br>				resource: {<br>					versionCodes: [versionCode]<br>				}<br>			},function(err,req){<br>				console.dir(err);<br>				androidpublisher.edits.commit({<br>					packageName: &quot;ga.yayeyo.cronoquiz.historia&quot;,<br>					editId: edit.id<br>				},function(err,req){<br>					console.dir(err);<br>				});<br>			});<br>		});<br>	});<br>});<br></pre><br>